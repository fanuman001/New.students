<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Grand Master Billiards v23.0 - Physics & Semi-Circle Pockets</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;900&display=swap');
        body { margin: 0; background: #020617; color: #f8fafc; position: fixed; width: 100%; height: 100%; overflow: hidden; font-family: 'system-ui'; }
        #app { display: flex; flex-direction: column; height: 100%; }
        #table-wrapper { flex: 1; display: flex; justify-content: center; align-items: center; background: radial-gradient(circle, #0f172a 0%, #020617 100%); position: relative; padding: 10px; }
        #canvas-container { position: relative; border: 14px solid #3f1a01; border-radius: 24px; box-shadow: 0 0 50px rgba(0,0,0,0.8); background: #064e3b; touch-action: none; }
        .team-box { background: rgba(30, 41, 59, 0.7); padding: 12px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.1); transition: all 0.3s; }
        .active-turn { border-color: #10b981 !important; background: rgba(16, 185, 129, 0.1); box-shadow: 0 0 15px rgba(16,185,129,0.3); }
        .pocket-hole { position: absolute; background: #000; z-index: 1; box-shadow: inset 0 6px 12px rgba(0,0,0,0.9); border: 1px solid #444; pointer-events: none; }
        .round-pocket { border-radius: 50%; }
        .semi-pocket-l { border-radius: 0 100px 100px 0; } /* 左中袋半圓 */
        .semi-pocket-r { border-radius: 100px 0 0 100px; } /* 右中袋半圓 */
        #power-meter { position: absolute; bottom: 80px; left: 50%; transform: translateX(-50%); width: 200px; height: 10px; background: #1e293b; border-radius: 10px; display: none; overflow: hidden; z-index: 100; border: 1px solid rgba(255,255,255,0.1); }
        #power-fill { width: 0%; height: 100%; background: linear-gradient(90deg, #10b981, #34d399); }
        .font-game { font-family: 'Orbitron', sans-serif; }
        .score-popup { position: absolute; pointer-events: none; animation: floatUp 1.2s ease-out forwards; color: #fbbf24; font-weight: 900; z-index: 1000; font-family: 'Orbitron'; text-shadow: 0 0 10px rgba(0,0,0,1); }
        @keyframes floatUp { 0% { opacity: 0; transform: translateY(10px); } 20% { opacity: 1; } 100% { opacity: 0; transform: translateY(-60px); } }
    </style>
</head>
<body>

<div id="app">
    <div id="config-ui" class="absolute inset-0 bg-slate-950/98 z-[3000] flex items-center justify-center backdrop-blur-xl">
        <div class="bg-slate-900/80 p-8 rounded-[2rem] border border-white/10 w-80 text-center shadow-2xl">
            <h1 class="text-3xl font-black text-emerald-400 mb-6 font-game italic">SET UP</h1>
            <div class="space-y-4 mb-8 text-left">
                <div>
                    <label class="text-[9px] text-emerald-500/70 font-bold block mb-1 uppercase tracking-widest">Total Ammo</label>
                    <input type="number" id="ball-qty" value="5" class="bg-slate-800 text-white text-xl font-game w-full px-4 py-2 rounded-xl border border-white/5 outline-none">
                </div>
                <div>
                    <label class="text-[9px] text-emerald-500/70 font-bold block mb-1 uppercase tracking-widest">Bonus Balls</label>
                    <input type="number" id="bonus-qty" value="3" min="1" max="10" class="bg-slate-800 text-white text-xl font-game w-full px-4 py-2 rounded-xl border border-white/5 outline-none">
                </div>
            </div>
            <button id="start-setup-btn" class="w-full bg-emerald-600 py-4 rounded-xl font-game text-lg font-bold hover:bg-emerald-500 transition-all">INITIALIZE</button>
        </div>
    </div>

    <div id="rps-ui" class="absolute inset-0 bg-slate-950/95 z-[2000] hidden flex items-center justify-center backdrop-blur-md">
        <div class="text-center">
            <h2 class="text-xl font-game mb-10 text-white tracking-widest">WHO GOES FIRST?</h2>
            <div class="flex gap-4">
                <button onclick="playRPS('rock')" class="bg-slate-800 w-20 h-20 rounded-2xl text-3xl hover:bg-emerald-600 transition-all">✊</button>
                <button onclick="playRPS('paper')" class="bg-slate-800 w-20 h-20 rounded-2xl text-3xl hover:bg-emerald-600 transition-all">✋</button>
                <button onclick="playRPS('scissors')" class="bg-slate-800 w-20 h-20 rounded-2xl text-3xl hover:bg-emerald-600 transition-all">✌️</button>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-2 gap-3 p-4 bg-slate-950/80 border-b border-white/5">
        <div id="team-0-box" class="team-box border-l-4 border-rose-500">
            <span class="text-[8px] font-game text-rose-400">PLAYER</span>
            <div id="team-0-score" class="text-3xl font-game font-bold">00</div>
            <div id="team-0-ammo" class="text-[9px] text-slate-500">AMMO: 5</div>
        </div>
        <div id="team-1-box" class="team-box border-l-4 border-cyan-500">
            <span class="text-[8px] font-game text-cyan-400">AI</span>
            <div id="team-1-score" class="text-3xl font-game font-bold text-right">00</div>
            <div id="team-1-ammo" class="text-[9px] text-slate-500 text-right">AMMO: 5</div>
        </div>
    </div>

    <div id="table-wrapper">
        <div id="canvas-container"></div>
        <div id="ai-status" class="absolute top-10 left-1/2 -translate-x-1/2 bg-cyan-600 text-white px-4 py-1 rounded-full text-[10px] font-bold font-game opacity-0 transition-all">AI THINKING...</div>
        <div id="power-meter"><div id="power-fill"></div></div>
    </div>

    <div class="p-4 bg-slate-900 border-t border-white/5">
        <div class="flex gap-3">
            <div id="instruction" class="flex-1 text-[9px] font-game text-emerald-400 self-center uppercase">Ready</div>
            <button id="main-btn" class="flex-[2] bg-emerald-600 py-3 rounded-xl font-game text-xs font-black tracking-widest">DEPO BALL</button>
        </div>
    </div>
</div>

<script>
    const { Engine, Render, Runner, Bodies, Composite, Events, Vector, Body } = Matter;
    const engine = Engine.create({ positionIterations: 25, velocityIterations: 25 });
    engine.gravity.scale = 0;

    const container = document.getElementById('canvas-container');
    const tableH = Math.min(window.innerHeight * 0.52, 600);
    const tableW = tableH / 2;
    const scale = tableW / 137;
    const ballR = (6.0 * scale) / 2;
    const pkSize = ballR * 3.2; // 稍微增大袋口

    const render = Render.create({
        element: container, engine: engine,
        options: { width: tableW, height: tableH, wireframes: false, background: 'transparent' }
    });

    let balls = [], activeBall = null, gameState = 'CONFIG', turnIdx = 0;
    let teamData = [{score:0, ammo:5, bonusCount:0}, {score:0, ammo:5, bonusCount:0}];
    let bonusTotal = 3, bonusPlaced = 0;
    let dragStart = null, currentPt = null;

    function buildTable() {
        Composite.clear(engine.world);
        const wallOpt = { isStatic: true, restitution: 0.8, friction: 0.02, render: { fillStyle: '#1e293b' } };
        
        // 牆壁邏輯增強：將長邊牆壁分段，為中袋騰出空間，避免直角碰撞
        const segmentH = tableH / 2 - pkSize;
        Composite.add(engine.world, [
            // 上下短邊
            Bodies.rectangle(tableW/2, -50, tableW, 100, wallOpt),
            Bodies.rectangle(tableW/2, tableH + 50, tableW, 100, wallOpt),
            // 左長邊 (分兩段)
            Bodies.rectangle(-50, segmentH/2, 100, segmentH, wallOpt),
            Bodies.rectangle(-50, tableH - segmentH/2, 100, segmentH, wallOpt),
            // 右長邊 (分兩段)
            Bodies.rectangle(tableW + 50, segmentH/2, 100, segmentH, wallOpt),
            Bodies.rectangle(tableW + 50, tableH - segmentH/2, 100, segmentH, wallOpt)
        ]);
        
        // 繪製半圓與圓形袋口
        container.querySelectorAll('.pocket-hole').forEach(h => h.remove());
        const pockets = [
            {x:0, y:0, type:'round'}, {x:tableW, y:0, type:'round'}, 
            {x:0, y:tableH/2, type:'semi-l'}, {x:tableW, y:tableH/2, type:'semi-r'}, 
            {x:0, y:tableH, type:'round'}, {x:tableW, y:tableH, type:'round'}
        ];

        pockets.forEach(p => {
            const h = document.createElement('div');
            h.className = 'pocket-hole';
            if(p.type === 'round') {
                h.classList.add('round-pocket');
                h.style.width = h.style.height = (pkSize * 1.5) + 'px';
                h.style.left = (p.x - pkSize * 0.75) + 'px';
                h.style.top = (p.y - pkSize * 0.75) + 'px';
            } else {
                // 中袋半圓邏輯
                h.classList.add(p.type === 'semi-l' ? 'semi-pocket-l' : 'semi-pocket-r');
                h.style.width = (pkSize * 1.2) + 'px';
                h.style.height = (pkSize * 2.4) + 'px';
                h.style.left = (p.type === 'semi-l' ? -pkSize * 0.4 : tableW - pkSize * 0.8) + 'px';
                h.style.top = (p.y - pkSize * 1.2) + 'px';
            }
            container.appendChild(h);
        });
    }

    function createBall(x, y, color, label) {
        const b = Bodies.circle(x, y, ballR, {
            label, restitution: 0.85, frictionAir: 0.02, friction: 0.01, frictionStatic: 0.1,
            render: { fillStyle: color, strokeStyle: '#fff', lineWidth: 1.5 }
        });
        Composite.add(engine.world, b);
        balls.push(b);
        return b;
    }

    function showPopup(x, y, text, color = "#fbbf24") {
        const p = document.createElement('div');
        p.className = 'score-popup';
        p.style.left = x + 'px';
        p.style.top = y + 'px';
        p.style.color = color;
        p.innerText = text;
        container.appendChild(p);
        setTimeout(() => p.remove(), 1200);
    }

    function launch(f) {
        Body.applyForce(activeBall, activeBall.position, f);
        gameState = 'MOVING';
        const timer = setInterval(() => {
            // 增加邏輯：當球速極慢時強制停止，避免無限微動
            balls.forEach(b => { if(b.speed < 0.15) Body.setVelocity(b, {x:0, y:0}); });
            if (balls.every(b => b.speed === 0)) {
                clearInterval(timer); 
                processTurn();
            }
        }, 300);
    }

    function processTurn() {
        if (teamData[0].ammo <= 0 && teamData[1].ammo <= 0) {
            handleEndgameBonus();
            gameState = 'END'; document.getElementById('instruction').innerText = "GAME OVER";
            return;
        }
        turnIdx = (turnIdx + 1) % 2;
        if (teamData[turnIdx].ammo <= 0) turnIdx = (turnIdx + 1) % 2;
        gameState = 'IDLE'; updateUI();
        document.getElementById('main-btn').innerText = "DEPO BALL";
        if (turnIdx === 1) setTimeout(aiProcess, 800);
    }

    function handleEndgameBonus() {
        if (balls.length === 0) return;
        let closestBall = balls.reduce((prev, curr) => (curr.position.y < prev.position.y) ? curr : prev);
        if (closestBall) {
            let winnerIdx = closestBall.label === 'TEAM_0' ? 0 : (closestBall.label === 'TEAM_1' ? 1 : -1);
            if (winnerIdx !== -1) {
                teamData[winnerIdx].score += 75;
                showPopup(closestBall.position.x, closestBall.position.y, "WINNER +75!", "#fbbf24");
                updateUI();
            }
        }
    }

    Events.on(engine, 'afterUpdate', () => {
        balls.forEach((b, idx) => {
            const p = b.position;
            // 進袋判定：包含四角圓袋與中袋半圓感應
            const inCorner = (p.x < 15 || p.x > tableW - 15) && (p.y < 15 || p.y > tableH - 15);
            const inMid = (p.y > tableH/2 - pkSize && p.y < tableH/2 + pkSize) && (p.x < 10 || p.x > tableW - 10);
            
            if (inCorner || inMid) {
                const currentTeam = teamData[turnIdx];
                if (b.label === 'BONUS') {
                    currentTeam.bonusCount++;
                    const points = currentTeam.bonusCount * 50;
                    currentTeam.score += points;
                    showPopup(p.x, p.y, `+${points} BONUS!`);
                } else if (b.label.startsWith('TEAM_')) {
                    const ownerIdx = parseInt(b.label.split('_')[1]);
                    if (ownerIdx !== turnIdx) {
                        currentTeam.score += 25;
                        showPopup(p.x, p.y, "+25 ENEMY!");
                    } else {
                        showPopup(p.x, p.y, "SELF GOAL", "#94a3b8");
                    }
                }
                Composite.remove(engine.world, b);
                balls.splice(idx, 1);
                updateUI();
            }
        });
    });

    // 其他邏輯 (RPS, AI, Touch) 保持不變並正確運作
    function playRPS(p) {
        const a = ['rock', 'paper', 'scissors'][Math.floor(Math.random() * 3)];
        document.getElementById('rps-ui').classList.add('hidden');
        if (p === a) { document.getElementById('rps-ui').classList.remove('hidden'); return; }
        turnIdx = ({ rock: 'scissors', paper: 'rock', scissors: 'paper' }[p] === a) ? 0 : 1;
        gameState = 'IDLE'; updateUI();
        if (turnIdx === 1) setTimeout(aiProcess, 1000);
    }

    async function aiProcess() {
        if (gameState !== 'IDLE') return;
        spawnNew();
        document.getElementById('ai-status').style.opacity = 1; 
        await new Promise(r => setTimeout(r, 1000));
        const targets = balls.filter(b => b !== activeBall);
        if (targets.length === 0) return;
        const target = targets[Math.floor(Math.random() * targets.length)];
        const vec = Vector.sub(target.position, activeBall.position);
        launch(Vector.mult(Vector.normalise(vec), Math.min(Vector.magnitude(vec), 100) * 0.00006));
        document.getElementById('ai-status').style.opacity = 0;
        teamData[1].ammo--; updateUI();
    }

    function updateUI() {
        teamData.forEach((t, i) => {
            document.getElementById(`team-${i}-score`).innerText = t.score.toString().padStart(2, '0');
            document.getElementById(`team-${i}-ammo`).innerText = `AMMO: ${t.ammo}`;
            document.getElementById(`team-${i}-box`).className = `team-box border-l-4 ${turnIdx===i?'active-turn':''} ${i===0?'border-rose-500':'border-cyan-500'}`;
        });
    }

    Events.on(render, 'afterRender', () => {
        const ctx = render.context;
        ctx.fillStyle = 'rgba(251, 191, 36, 0.1)'; ctx.fillRect(0, 0, tableW, 10);
        if (gameState === 'READY' && dragStart && currentPt && activeBall) {
            const dx = dragStart.x - currentPt.x, dy = dragStart.y - currentPt.y;
            ctx.strokeStyle = '#10b981'; ctx.lineWidth = 3;
            ctx.beginPath(); ctx.moveTo(activeBall.position.x, activeBall.position.y); ctx.lineTo(activeBall.position.x + dx * 5, activeBall.position.y + dy * 5); ctx.stroke();
        }
    });

    container.addEventListener('touchstart', (e) => {
        const r = container.getBoundingClientRect();
        const tx = e.touches[0].clientX - r.left, ty = e.touches[0].clientY - r.top;
        if (gameState === 'SETUP_BONUS') {
            if (ty >= triTop && ty <= triBottom && bonusPlaced < bonusTotal) {
                createBall(tx, ty, (bonusPlaced % 2 === 0 ? '#000' : '#fff'), 'BONUS');
                bonusPlaced++;
                if (bonusPlaced >= bonusTotal) { gameState = 'RPS'; document.getElementById('rps-ui').classList.remove('hidden'); }
            }
        } else if (gameState === 'READY' && turnIdx === 0) {
            dragStart = { x: tx, y: ty };
            document.getElementById('power-meter').style.display = 'block';
        }
        e.preventDefault();
    }, { passive: false });

    container.addEventListener('touchmove', (e) => {
        const r = container.getBoundingClientRect();
        currentPt = { x: e.touches[0].clientX - r.left, y: e.touches[0].clientY - r.top };
        if (gameState === 'SPAWNED') Body.setPosition(activeBall, { x: Math.max(ballR, Math.min(tableW-ballR, currentPt.x)), y: Math.max(tableH*0.7, currentPt.y) });
        if (dragStart && currentPt) document.getElementById('power-fill').style.width = Math.min(100, Vector.magnitude(Vector.sub(dragStart, currentPt))) + '%';
        e.preventDefault();
    }, { passive: false });

    container.addEventListener('touchend', () => {
        if (gameState === 'READY' && dragStart && currentPt) {
            launch(Vector.mult(Vector.sub(dragStart, currentPt), 0.000085));
            teamData[0].ammo--; updateUI();
        }
        document.getElementById('power-meter').style.display = 'none'; dragStart = null;
    });

    document.getElementById('start-setup-btn').onclick = () => {
        teamData[0].ammo = teamData[1].ammo = parseInt(document.getElementById('ball-qty').value);
        bonusTotal = parseInt(document.getElementById('bonus-qty').value);
        document.getElementById('config-ui').classList.add('hidden');
        buildTable(); gameState = 'SETUP_BONUS';
        document.getElementById('instruction').innerText = "Place Bonus Balls";
    };

    document.getElementById('main-btn').onclick = () => {
        if (gameState === 'IDLE') spawnNew();
        else if (gameState === 'SPAWNED') { gameState = 'READY'; document.getElementById('main-btn').innerText = "RELEASE"; }
    };

    function spawnNew() {
        activeBall = createBall(tableW/2, tableH * 0.85, turnIdx===0?'#f43f5e':'#06b6d4', `TEAM_${turnIdx}`);
        gameState = 'SPAWNED'; document.getElementById('main-btn').innerText = "SET POS";
    }

    Render.run(render); Runner.run(Runner.create(), engine);
</script>
</body>
</html>

