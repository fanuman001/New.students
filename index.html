<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Billiard Pro: Multi-Team Edition</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; background: #020617; color: white; position: fixed; width: 100%; height: 100%; overflow: hidden; font-family: sans-serif; }
        #app { display: flex; flex-direction: column; height: 100%; }
        #table-wrapper { flex: 1; display: flex; justify-content: center; align-items: center; background: #000; position: relative; }
        .config-overlay { position: absolute; inset: 0; background: rgba(15,23,42,0.98); z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .stat-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; padding: 10px; background: #0f172a; border-bottom: 2px solid #1e293b; }
        .team-box { padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: bold; border: 1px solid rgba(255,255,255,0.1); }
        .pocket-glow { pointer-events: none; position: absolute; border-radius: 50%; box-shadow: 0 0 15px rgba(52, 211, 153, 0.5); border: 2px solid rgba(52, 211, 153, 0.3); }
    </style>
</head>
<body>

<div id="app">
    <div id="config-ui" class="config-overlay">
        <div class="bg-slate-800 p-8 rounded-3xl w-80 shadow-2xl border border-slate-700">
            <h2 class="text-emerald-400 text-xl font-black mb-6 text-center">ğŸ† è³½äº‹è¨­å®šå¾Œå°</h2>
            <div class="space-y-4 text-sm">
                <div>
                    <label class="text-slate-400 text-xs uppercase">åƒè³½éšŠä¼æ•¸</label>
                    <select id="team-count" class="w-full bg-slate-900 p-2 rounded mt-1 outline-none border border-slate-700">
                        <option value="2">2 éšŠ (ç´… vs è—)</option>
                        <option value="3">3 éšŠ (ç´… vs è— vs é»ƒ)</option>
                        <option value="4">4 éšŠ (ç´… vs è— vs é»ƒ vs ç´«)</option>
                    </select>
                </div>
                <div class="flex gap-2">
                    <div class="flex-1">
                        <label class="text-slate-400 text-xs uppercase">å„éšŠçƒæ•¸</label>
                        <input type="number" id="ball-qty" value="3" class="w-full bg-slate-900 p-2 rounded mt-1 text-center">
                    </div>
                    <div class="flex-1">
                        <label class="text-slate-400 text-xs uppercase">åŠ åˆ†é»‘çƒ</label>
                        <input type="number" id="black-qty" value="1" class="w-full bg-slate-900 p-2 rounded mt-1 text-center">
                    </div>
                </div>
                <div class="flex items-center justify-between py-2 border-t border-slate-700 mt-2">
                    <span class="text-xs uppercase">é›»è…¦é¸æ‰‹ (AI)</span>
                    <input type="checkbox" id="ai-toggle" checked class="w-4 h-4">
                </div>
                <button id="start-btn" class="w-full bg-emerald-600 py-3 rounded-xl font-black text-lg mt-4 shadow-lg shadow-emerald-900/40">é–‹å§‹æ¯”è³½</button>
            </div>
        </div>
    </div>

    <div id="score-board" class="stat-grid">
        </div>

    <div id="table-wrapper">
        <div id="canvas-container" class="relative"></div>
        <div id="prox-tag" class="absolute top-2 right-2 text-[10px] bg-black/50 p-1 px-2 rounded border border-white/10 text-emerald-400 font-mono">æœ€é ‚: --</div>
    </div>

    <div class="bg-slate-900 p-4 flex flex-col gap-3 border-t border-slate-800">
        <div class="flex justify-between items-center px-2">
            <span id="info-msg" class="text-xs font-bold text-yellow-500 uppercase">æº–å‚™å°±ç·’</span>
            <label class="flex items-center gap-2 text-[10px] text-slate-400">
                <input type="checkbox" id="fast-ai"> AI å¿«é€²æ¨¡å¼
            </label>
        </div>
        <div class="flex gap-2">
            <button id="undo-btn" class="bg-slate-800 px-6 rounded-xl text-xs font-bold opacity-30" disabled>UNDO</button>
            <button id="main-btn" class="flex-1 bg-emerald-600 py-3 rounded-xl font-black text-sm uppercase">ç¢ºå®šä½ç½®</button>
        </div>
    </div>
</div>

<script>
    const { Engine, Render, Runner, Bodies, Composite, Events, Vector, Body } = Matter;
    const engine = Engine.create(); engine.gravity.y = 0;
    
    const container = document.getElementById('canvas-container');
    const tableH = document.getElementById('table-wrapper').clientHeight - 40, tableW = tableH / 2;
    const scale = tableW / 137, ballR = (5.7 * scale) / 2.2, pkSize = ballR * 3.8;
    const triY = tableH * 0.12, triW = 60 * scale;
    const colors = ['#ef4444', '#3b82f6', '#eab308', '#a855f7']; // ç´…, è—, é»ƒ, ç´«

    const render = Render.create({ element: container, engine: engine, options: { width: tableW, height: tableH, wireframes: false, background: '#064e3b' } });

    let cfg = { teamCount: 2, ballQty: 3, blackQty: 1, ai: true },
        gameState = 'CONFIG', turnIdx = 0, balls = [], activeBall = null, 
        strikerIdx = 0, scores = [], history = null;

    // --- åˆå§‹åŒ–è¢‹å£ç‡ˆå…‰è¦–è¦º ---
    function createPocketUI() {
        const pks = [{x:0,y:0},{x:tableW,y:0},{x:0,y:tableH/2},{x:tableW,y:tableH/2},{x:0,y:tableH},{x:tableW,y:tableH}];
        pks.forEach(p => {
            const div = document.createElement('div');
            div.className = 'pocket-glow';
            div.style.width = div.style.height = (pkSize * 1.5) + 'px';
            div.style.left = (p.x - pkSize * 0.75) + 'px';
            div.style.top = (p.y - pkSize * 0.75) + 'px';
            container.appendChild(div);
        });
    }

    function initTable() {
        Composite.clear(engine.world);
        const cOpt = { isStatic: true, restitution: 0.9, friction: 0.01, render: { fillStyle: '#064e3b' } };
        const w = 15 * scale, g = pkSize;
        Composite.add(engine.world, [
            Bodies.rectangle(tableW/2, -w/2, tableW - g*1.8, w, cOpt),
            Bodies.rectangle(tableW/2, tableH+w/2, tableW - g*1.8, w, cOpt),
            Bodies.rectangle(-w/2, tableH*0.25, w, tableH*0.45 - g, cOpt),
            Bodies.rectangle(-w/2, tableH*0.75, w, tableH*0.45 - g, cOpt),
            Bodies.rectangle(tableW+w/2, tableH*0.25, w, tableH*0.45 - g, cOpt),
            Bodies.rectangle(tableW+w/2, tableH*0.75, w, tableH*0.45 - g, cOpt)
        ]);
        
        for(let i=0; i<cfg.blackQty; i++) balls.push(createBall(tableW/2, triY+20+(i*20), '#000', 'é»‘çƒ', '#fbbf24'));
        balls.push(createBall(tableW/2, triY+70, '#fff', 'æ¯çƒ', '#94a3b8'));
        Composite.add(engine.world, balls);
        gameState = 'SETTING';
        createPocketUI();
        initScoreBoard();
    }

    function initScoreBoard() {
        const board = document.getElementById('score-board');
        board.innerHTML = '';
        scores = Array.from({length: cfg.teamCount}, () => 0);
        for(let i=0; i<cfg.teamCount; i++) {
            board.innerHTML += `<div class="team-box" style="color: ${colors[i]}">Team ${String.fromCharCode(65+i)}: <span id="s-${i}">0</span></div>`;
        }
    }

    function createBall(x, y, color, label, stroke) {
        return Bodies.circle(x, y, ballR, { label, restitution: 0.9, frictionAir: 0.015, render: { fillStyle: color, strokeStyle: stroke, lineWidth: 2 } });
    }

    // --- äº¤äº’è™•ç† ---
    let startPt = null, currentPt = null;
    render.canvas.addEventListener('touchstart', (e) => {
        const rect = render.canvas.getBoundingClientRect();
        const pt = { x: e.touches[0].clientX - rect.left, y: e.touches[0].clientY - rect.top };
        balls.forEach(b => {
            if (Vector.magnitude(Vector.sub(b.position, pt)) < 25) {
                if (gameState === 'SETTING' && (b.label==='é»‘çƒ'||b.label==='æ¯çƒ')) activeBall = b;
                if (gameState === 'SPAWNED' && b === activeBall) activeBall = b;
                if (gameState === 'READY' && b === activeBall) { startPt = pt; currentPt = pt; }
            }
        });
    });

    render.canvas.addEventListener('touchmove', (e) => {
        const rect = render.canvas.getBoundingClientRect();
        const pt = { x: e.touches[0].clientX - rect.left, y: e.touches[0].clientY - rect.top };
        currentPt = pt;
        if (activeBall && gameState === 'SETTING') {
            const bx = Math.max(tableW/2-triW/2+ballR, Math.min(tableW/2+triW/2-ballR, pt.x));
            const by = Math.max(triY+ballR, Math.min(triY+triW-ballR, pt.y));
            Body.setPosition(activeBall, {x: bx, y: by});
        }
        if (activeBall && gameState === 'SPAWNED' && pt.y > tableH*0.75) Body.setPosition(activeBall, pt);
        e.preventDefault();
    }, {passive:false});

    render.canvas.addEventListener('touchend', () => {
        if (gameState === 'READY' && startPt && currentPt) {
            const f = Vector.mult(Vector.sub(startPt, currentPt), 0.00085);
            if (Vector.magnitude(f) > 0.005) {
                strikerIdx = turnIdx; // é–å®šç›®å‰æ˜¯èª°æ“Šçƒ
                launch(f);
            }
        }
        startPt = null;
    });

    function launch(f) {
        saveHistory();
        Body.applyForce(activeBall, activeBall.position, f);
        gameState = 'MOVING';
        document.getElementById('info-msg').innerText = "é‹è¡Œä¸­...";
        checkStop();
    }

    function checkStop() {
        const i = setInterval(() => {
            if (balls.every(b => b.speed < 0.15)) {
                clearInterval(i);
                updateProx();
                turnIdx = (turnIdx + 1) % cfg.teamCount;
                gameState = 'IDLE';
                document.getElementById('info-msg').innerText = `è¼ªåˆ° Team ${String.fromCharCode(65+turnIdx)}`;
                document.getElementById('main-btn').innerText = `éšŠä¼ ${String.fromCharCode(65+turnIdx)} ç™¼çƒ`;
                if (cfg.ai && turnIdx > 0) setTimeout(aiThink, 1000);
            }
        }, 600);
    }

    // --- AI é‚è¼¯ä¿®æ­£ ---
    async function aiThink() {
        spawnBall();
        const fast = document.getElementById('fast-ai').checked;
        if (!fast) {
            document.getElementById('info-msg').innerText = "AI æ­£åœ¨æ€è€ƒç„æº–...";
            await new Promise(r => setTimeout(r, 1500));
        }
        gameState = 'READY';
        const target = balls.find(b => b.label.includes('éšŠ') && b.label !== String.fromCharCode(65+turnIdx)+'éšŠ') || balls[0];
        const dir = Vector.normalise(Vector.sub(target.position, activeBall.position));
        strikerIdx = turnIdx;
        launch(Vector.mult(dir, 0.012 + Math.random()*0.005));
    }

    // --- é€²çƒåˆ¤å®šä¿®æ­£ ---
    Events.on(engine, 'afterUpdate', () => {
        balls.forEach((b, idx) => {
            if (b.position.x < -20 || b.position.x > tableW+20 || b.position.y < -20 || b.position.y > tableH+20) {
                const victimLabel = b.label;
                const strikerLabel = String.fromCharCode(65 + strikerIdx) + 'éšŠ';
                
                // åªæœ‰é€²åˆ¥äººçš„çƒï¼Œæ“Šçƒè€…æ‰å¾—åˆ†
                if (victimLabel.includes('éšŠ') && victimLabel !== strikerLabel) {
                    scores[strikerIdx]++;
                }
                
                Composite.remove(engine.world, b);
                balls.splice(idx, 1);
                updateScoreUI();
            }
        });
    });

    function updateScoreUI() {
        scores.forEach((s, i) => document.getElementById(`s-${i}`).innerText = s);
    }

    function updateProx() {
        let best = Infinity, win = "--";
        balls.forEach(b => { if (b.position.y < best) { best = b.position.y; win = b.label; } });
        document.getElementById('prox-tag').innerText = `æœ€é è¿‘åº•ç·š: ${win}`;
    }

    // --- å¾Œå°æŒ‰éˆ• ---
    document.getElementById('start-btn').addEventListener('click', () => {
        cfg = { 
            teamCount: parseInt(document.getElementById('team-count').value), 
            ballQty: parseInt(document.getElementById('ball-qty').value), 
            blackQty: parseInt(document.getElementById('black-qty').value), 
            ai: document.getElementById('ai-toggle').checked 
        };
        document.getElementById('config-ui').style.display = 'none';
        initTable();
    });

    document.getElementById('main-btn').addEventListener('click', () => {
        if (gameState === 'SETTING') { gameState = 'IDLE'; document.getElementById('main-btn').innerText = "ç™¼çƒ"; }
        else if (gameState === 'IDLE') spawnBall();
        else if (gameState === 'SPAWNED') { gameState = 'READY'; document.getElementById('main-btn').innerText = "æ‹‰çƒæ“Šç™¼"; }
    });

    function spawnBall() {
        activeBall = createBall(tableW/2, tableH*0.85, colors[turnIdx], String.fromCharCode(65+turnIdx)+'éšŠ', '#fff');
        balls.push(activeBall); Composite.add(engine.world, activeBall);
        gameState = 'SPAWNED';
        document.getElementById('main-btn').innerText = "ç¢ºèªä½ç½®";
    }

    function saveHistory() {
        history = { balls: balls.map(b=>({x:b.position.x, y:b.position.y, l:b.label, c:b.render.fillStyle})), turnIdx, scores: [...scores] };
        document.getElementById('undo-btn').disabled = false; document.getElementById('undo-btn').classList.remove('opacity-30');
    }

    document.getElementById('undo-btn').addEventListener('click', () => {
        if (!history) return;
        balls.forEach(b => Composite.remove(engine.world, b));
        balls = history.balls.map(h => createBall(h.x, h.y, h.c, h.l, '#fff'));
        Composite.add(engine.world, balls); turnIdx = history.turnIdx; scores = [...history.scores];
        gameState = 'READY'; activeBall = balls[balls.length-1]; history = null;
        updateScoreUI();
        document.getElementById('undo-btn').disabled = true; document.getElementById('undo-btn').classList.add('opacity-30');
    });

    // ç¹ªè£½æ“Šçƒç·š
    Events.on(render, 'afterRender', () => {
        const ctx = render.context;
        if (gameState === 'READY' && activeBall && startPt && currentPt) {
            ctx.beginPath();
            ctx.moveTo(activeBall.position.x, activeBall.position.y);
            const dx = startPt.x - currentPt.x, dy = startPt.y - currentPt.y;
            ctx.lineTo(activeBall.position.x + dx*10, activeBall.position.y + dy*10);
            ctx.strokeStyle = 'rgba(255,255,255,0.3)'; ctx.setLineDash([5,5]); ctx.stroke(); ctx.setLineDash([]);
        }
        // ä¸‰è§’å½¢ UI
        ctx.strokeStyle = '#34d399'; ctx.setLineDash([5,5]);
        ctx.beginPath(); ctx.moveTo(tableW/2, triY+triW); ctx.lineTo(tableW/2-triW/2, triY); ctx.lineTo(tableW/2+triW/2, triY); ctx.closePath(); ctx.stroke();
    });

    Render.run(render); Runner.run(Runner.create(), engine);
</script>
</body>
</html>

